<template>
    <div class="" >
      <q-btn class="q-mr-xs" flat square
        v-for="App in Menus" :key="App"
        style="padding: 0px;"
        v-show="Modelos.includes(App.app) && User.isAuthorized(App.app.toLowerCase())"
        :icon="App.icon"
        :label="tdc(App.menu)"
      >
        <q-menu auto-close>
          <q-list  style="min-width: 150px">
            <q-item  v-for="sm in App.submenu " :key="sm"
              dense
              clickable v-ripple
              :to="{name: sm?.rota}"
              v-show="User.isAuthorized(sm.role.toLowerCase())"
            >
              <q-item-section avatar>
                <q-icon :name="sm.icon" />
              </q-item-section>
              <q-item-section>{{tdc(sm.menu)}}</q-item-section>
              <q-item-section side >
                <q-item dense  style="margin-right: -20px;"
                  v-show="User.isAuthorized('add_' + sm.menu.toLowerCase())"
                  clickable v-ripple
                  :to="{name: 'add_' + sm.menu.toLowerCase()}"
                >
                  <q-icon name="add" size="sm" :color="$q.dark.isActive ? '' : 'primary'">
                    <q-tooltip :class="$q.dark.isActive ? 'bg-transparent' : 'bg-primary'">
                      {{ tdc('Adicionar ') }} {{ tdc(sm.menu) }}
                    </q-tooltip>
                  </q-icon>
                </q-item>
              </q-item-section>
            </q-item>
          </q-list>
        </q-menu>
      </q-btn>
      </div>
</template>

<script >

import { defineComponent } from 'vue'
import { tdc } from '../boot/app'
import { UserStore } from '../stores/AuthStore'


export default defineComponent({
  name: 'TopeMenuSegundo',

  props: {
    AllPermissions: {
      type: Array,
      required: true
    }
  },

  components: {

  },
  setup () {
    
    const User = UserStore()
    
    return {
      User,
    }
  },
  data () {
    return {
      AllMenus: [],
      Menus: [],
      Modelos: [],
      ModelosEntidade: [],
      optionsGroupPermissions: [],
      optionsAllPermissions: [],
      group: null,
      tdc: tdc,
      add_modal: false,
      searchAllPermission: null,
      searchPermission: null
    }
  },
  computed: {

  },
  watch: {
    AllPermissions (newVal, oldVal) {
      this.filterOptionsAllPermissions('')
    },

    'User.TipoEntidade'(newVal, oldVal) {
    this.setModelos()
    this.setMenus()
  }
  },
  mounted () {
    this.filterOptionsAllPermissions('')
  },
  methods: {
    async setModelos () {
      await HTTPAuth.get(url({ type: 'u', url: 'auth/entidades/' + this.User?.Entidade?.id + '/modelos', params: {} }))
        .then(res => {
          res.data.forEach(m => {
            this.ModelosEntidade.push(m.model)
            if (!this.Modelos.includes(m.app_label)) {
              this.Modelos.push(m.app_label)
            }
          })
        }).catch(err => {
          console.log(err)
        })
    },
    async setMenus () {
      await HTTPAuth.get(url({ type: 'u', url: 'auth/tipoEntidades/' + this.User?.TipoEntidade?.id + '/menus', params: {} }))
        .then(res => {
          this.AllMenus = res.data
          this.Menus = this.AllMenus
        }).catch(err => {
          console.log(err)
        })
    },
    filterOptionsAllPermissions (val) {
      if (val === '') {
        this.Menus = this.AllMenus
      } else {
        const needle = val.toLowerCase()
        this.Menus = this.AllMenus.map(v => ({
          ...v,
          submenu: v.submenu.filter(sub =>
            sub.menu && sub.menu.toLowerCase().includes(needle.toLowerCase())
          )
        })).filter(v => v.submenu.length > 0)
      }
    }
  }
})
</script>
