
<template>
  <div>
    <q-dialog
        v-model="showRegistarEntidade"
        persistent
        :maximized="maximizedToggle"
        full-height
      >
      <RegistarEntidade />
    </q-dialog>
    <q-dialog v-model="pergunta" persistent class="row">
        <q-card style="width: 400px;" flat>

          <q-card-section class="row ">
            <label class="text-h6 text-grey-9 text-center">
              {{tdc('De qual deseja sair')}}
            </label>
          </q-card-section>
          <q-separator />

          <q-card-actions class="row" >
            <q-btn flat   class="col-12" color="primary"  @click="logout(User.Entidade?.id)" > {{tdc(User.Entidade?.nome)}}</q-btn>
          </q-card-actions>

          <q-card-actions class="row" >
            <q-btn flat   class="col-12" color="primary"  @click="logout('x')" > {{tdc(User?.TipoEntidade?.nome)}}</q-btn>
          </q-card-actions>
          <q-separator/>
          <q-card-actions class="row" >
            <q-btn  class="col-12" flat v-close-popup>{{tdc('Cancelar')}}</q-btn>
          </q-card-actions>
        </q-card>

    </q-dialog>

    <q-btn round flat>
      <q-avatar class="" size="45px" :class="$q.dark.isActive ? 'bg-white' : 'bg-white'" >
        <img  v-if="UserPessoa" :src="User?.perfil?.url" >
        <img  v-else src="https://awsacademy.instructure.com/images/messages/avatar-50.png" >
        <q-card-actions align="center" v-if="User" flat>
          <div class="text-h6 text-gry-8 row text-center">{{User?.username}}</div>
        </q-card-actions>
        <q-separator />
        <q-menu flat  square  fit :offset="[130, 5]"  >
          <q-card class="my-card"  style="width:270px;"  flat bordered square  >
            <q-card-actions class="text-center row" v-if="User">
              <div class=" col-12">
                <q-avatar class="" size="120px"  >
                  <img  v-if="User" :src="User?.perfil?.url" >
                  <img  v-else src="https://awsacademy.instructure.com/images/messages/avatar-50.png" >
                </q-avatar>
              </div>
              <div class=" text-center col-12 text-grey-9 text-h6">
                {{User?.username}}
              </div>
            </q-card-actions>
            <q-separator  v-if="User" />
            <q-expansion-item
                v-if="User"
                dense
                group="group"
                :label="tdc('Entidade') "
                header-class=" text-grey-9"
                :caption="UserEntidade?.nome"
              >
                <q-separator />
                <q-item dense clickable v-if="User.TipoEntidade?.crair_entidade"   :to="{name:'add_entidade_self', params:{}}"  >
                  <q-item-section>
                    <center><q-item-label overline class="text-blue"> {{ tdc('Registar Entidade')}}</q-item-label> </center>
                  </q-item-section>
                </q-item>
                <q-item dense clickable v-for="entidade in User?.Entidades" :key="entidade?.id" @click="selectEntidade(entidade)">
                  <q-item-section>
                    <center><q-item-label overline> {{ tdc((entidade?.nome))}}</q-item-label> </center>
                  </q-item-section>
                </q-item>
              </q-expansion-item>

              <q-expansion-item
                v-if="UserEntidade"
                dense
                group="group"
                :label="tdc('Sucursal') "
                header-class=" text-grey-9"
                :caption="UserSucursal?.nome"
                default-opened
                v-model="sucursalClosed"
              >
                <q-separator />
                <q-item dense clickable v-for="sucursal in User?.Sucursals" :key="sucursal?.id"   @click="selectSucursal(sucursal)">
                  <q-item-section>
                    <center><q-item-label overline> {{ tdc(sucursal?.nome)}}</q-item-label> </center>
                  </q-item-section>
                </q-item>
              </q-expansion-item>

            <q-btn dense  flat  size="" @click="sucursalClosed = false" color="grey" :label="tdc(perfilSplint(User.Grupo?.name)) " style="width: 100%; border-color: transparent;">
              <q-menu fit>
                <q-list dense   class="rounded-borders" style="min-width: 100px" >
                  <q-item clickable v-close-popup v-if="'domain'=='domain'" @click="selectGroup({id:'1', name:'Hóspede'})"  >
                    <q-item-section>
                      <q-item-label overline> {{tdc('Hóspede')}}</q-item-label>
                    </q-item-section>
                  </q-item>
                  <q-item clickable v-close-popup v-else @click="selectGroup({id:'1', name:'Hóspede'})"  >
                    <q-item-section>
                      <q-item-label overline> {{tdc('Hóspede')}}</q-item-label>
                    </q-item-section>
                  </q-item>

                  <q-item clickable v-close-popup @click="selectGroup(grupo)" v-ripple v-for=" grupo in User.Grupos" :key="grupo.id">
                    <q-item-section>
                      <q-item-label overline> {{ tdc(perfilSplint(grupo.name))}}</q-item-label>

                    </q-item-section>

                  </q-item>

                </q-list>
              </q-menu>
            </q-btn>
            <q-card-actions align="center" v-if="User">
              <q-btn  icon="settings" dense size=""  :to="{name:'userDetails', params:{'user_id': User?.id}}" flat color="secondary" class="">{{tdc('Definições')}}</q-btn>
              <q-btn  icon="logout" dense size="" flat color="red" @click="modal_pergunta">{{tdc('Sair')}}</q-btn>
            </q-card-actions>

            <q-card-actions align="center" v-else>
              <q-btn  dense size="" :to="{name:'registarUser'}" flat color="primary" class="" :label="tdc('Registar')" />
              <q-btn  dense size="" :to="{name:'login'}" flat color="secondary" class="" >{{tdc('login')}}</q-btn>
            </q-card-actions>
            <q-separator color="primary" dense size="xs" />
          </q-card>

        </q-menu>
      </q-avatar>
      <q-tooltip :class="$q.dark.isActive ? 'bg-transparent' : 'bg-primary'" v-if="User">{{User?.username }} </q-tooltip>
      <q-tooltip :class="$q.dark.isActive ? 'bg-transparent' : 'bg-primary'" v-else>{{tdc('Hóspede')}}</q-tooltip>
    </q-btn>
  </div>
</template>

<script>
import { defineComponent } from 'vue'
import { HTTPAuth, url } from '../../boot/api'
import { tdc } from '../../boot/app'
import { deleteStorage, getStorage, setStorage } from '../../boot/base'
import { UserStore } from '../../stores/AuthStore'
import RegistarEntidade from './RegistarEntidade.vue'

export default defineComponent({
  name: 'HeaderUser',
  components: { RegistarEntidade },

  setup () {
    const User = UserStore()
    return { User, tdc }
  },

  data () {
    return {
      sucursalClosed: true,
      pergunta: false,
      selectSucursalModal: false,
      showRegistarEntidade: false,
      entidade_id: null,
      UserEntidade: null,
      UserSucursal: null,
    }
  },

  methods: {
    /* ---------- PARSER SEGURO ---------- */
    safeParse (value) {
      try {
        return value ? JSON.parse(value) : null
      } catch {
        return null
      }
    },

    async getEntidades () {
      const userStorage = this.safeParse(getStorage('c', 'user'))

      if (this.User && userStorage) {
        this.User.data = userStorage
      }

      if (!this.User?.data?.id) return

      try {
        const ress = await HTTPAuth.get(
          url({
            type: 'u',
            url: `auth/usuarios/${this.User.data.id}/userEntidades/`,
            params: {}
          })
        )

        setStorage('c', 'userEntidades', JSON.stringify(ress.data), 365)

        if (ress.data.length === 1) {
          this.selectEntidade_(ress.data[0])
        } else {
          const entidades = ress.data.map(e => ({
            label: this.perfilSplint(e.nome),
            value: e
          }))

          this.$q.dialog({
            title: tdc('Seleccione a Entidade'),
            options: {
              type: 'radio',
              model: 'opt1',
              items: entidades
            },
            cancel: true,
            persistent: true
          }).onOk(data => this.selectEntidade_(data))
        }
      } catch (err) {
        console.error(err)
      }
    },

    selectEntidade_ (entidade) {
      this.entidade_id = entidade.id
      this.UserEntidade = entidade
      setStorage('c', 'userEntidade', JSON.stringify(entidade), 365)
      this.getUserSucursals_()
    },

    selectSucursal_ (sucursal) {
      this.UserSucursal = sucursal
      setStorage('c', 'userSucursal', JSON.stringify(sucursal), 365)
      this.getUserGrupos_()
    },

    async getUserSucursals_ () {
      try {
        const res = await HTTPAuth.get(
          url({ type: 'u', url: `auth/usuarios/${this.User?.id}/userSucursals/`, params: {} })
        )

        setStorage('c', 'userSucursals', JSON.stringify(res.data), 365)

        if (res.data.length === 1) {
          this.selectSucursal_(res.data[0])
        }
      } catch (err) {
        console.error(err)
      }
    },

    async getUserGrupos_ () {
      try {
        const res = await HTTPAuth.get(
          url({ type: 'u', url: `auth/usuarios/${this.User?.id}/User.Grupos/`, params: {} })
        )

        setStorage('c', 'User.Grupos', JSON.stringify(res.data), 365)

        if (res.data.length === 1) {
          this.selectGroup_(res.data[0])
        }
      } catch (err) {
        console.error(err)
      }
    },

    selectGroup_ (group) {
      this.User.Grupo = group
      setStorage('c', 'userGrupo', JSON.stringify(group), 365)
      this.getUserPermicoes_()
    },

    async getUserPermicoes_ () {
      if (!getStorage('c', 'userSucursal')) return

      try {
        const res = await HTTPAuth.get(
          url({ type: 'u', url: `auth/usuarios/${this.User?.id}/userPermicoes/`, params: {} })
        )

        setStorage('l', 'userPermicoes', JSON.stringify(res.data), 365)
        this.getEntidadeModulos_()
      } catch (err) {
        console.error(err)
      }
    },

    async getEntidadeModulos_ () {
      if (!this.entidade_id) return

      try {
        const res = await HTTPAuth.get(
          url({ type: 'u', url: `auth/entidades/${this.entidade_id}/modulos/`, params: {} })
        )

        setStorage('c', 'entidadeModulos', JSON.stringify(res.data), 365)
        window.location.reload()
      } catch (err) {
        console.error(err)
      }
    },

    perfilSplint (txt) {
      if (!txt) return null
      const p = txt.split('_')
      return p[1] ?? p[0]
    },

    modal_pergunta () {
      this.pergunta = !this.pergunta
    }
  },

  mounted () {
    /* ---------- LIMPEZA PREVENTIVA ---------- */
    ;['user', 'userEntidade', 'userSucursal', 'userGrupo'].forEach(k => {
      const v = getStorage('c', k)
      if (!v || v === 'undefined') {
        deleteStorage('c', k)
      }
    })

    /* ---------- LEITURA SEGURA ---------- */
    this.UserEntidade = this.safeParse(getStorage('c', 'userEntidade'))
    this.UserSucursal = this.safeParse(getStorage('c', 'userSucursal'))
    this.User.Grupo   = this.safeParse(getStorage('c', 'userGrupo'))

    if (!this.User.Grupo?.id) {
      // this.getEntidades()
    }
  }
})
</script>
