<template>
    <div class="col-12" style="margin-top: 2px;">

        <q-input  v-model="searchAllPermission"   :class="$q.dark.isActive ? 'bg-dark-custom ' : 'bg-white'"  dense @update:model-value="filterOptionsAllPermissions"
          :label=" ' ' + tdc(' Procurar') + ' '">
          <template v-slot:append>
            <q-icon name="search" />
          </template>
        </q-input>
        <q-card square flat  class=" col-xs-12 col-md-12 col-lg-12 q-bt-md"
          v-for="App in Menus" :key="App"
          style="padding: 0px;"
          v-show="Modelos.includes(App.app) && User.isAuthorized(App.app.toLowerCase())"
        >
          <q-expansion-item default-opened
            :class="$q.dark.isActive ? 'bg-dark-custom text-subtitle1' : 'bg-white text-subtitle1'"
            :icon="App.icon"
            dense
            :label="tdc(App.menu)"
            :header-class="$q.dark.isActive ? 'bg-dark text-white' : 'bg-primary text-white'"
            :expand-icon-class="$q.dark.isActive ? 'text-white' : 'text-white'"
          >
            <q-separator />

            <q-item  v-for="sm in App.submenu " :key="sm"
              dense
              clickable v-ripple
              :to="{name: sm?.rota}"
              v-show="User.isAuthorized(sm.role.toLowerCase())"
            >
              <q-item-section avatar>
                <q-icon :name="sm.icon" />
              </q-item-section>
              <q-item-section>{{tdc(sm.menu)}}</q-item-section>
              <q-item-section side >
                <q-item dense  style="margin-right: -20px;"
                  v-show="User.isAuthorized('add_' + sm.menu.toLowerCase())"
                  clickable v-ripple
                  :to="{name: 'add_' + sm.menu.toLowerCase()}"
                >
                  <q-icon name="add" size="sm" :color="$q.dark.isActive ? '' : 'primary'">
                    <q-tooltip :class="$q.dark.isActive ? 'bg-transparent' : 'bg-primary'">
                      {{ tdc('Adicionar ') }} {{ tdc(sm.menu) }}
                    </q-tooltip>
                  </q-icon>
                </q-item>
              </q-item-section>
            </q-item>
            <q-separator />
          </q-expansion-item>
        </q-card>
      </div>
</template>

<style scoped>
  .bg-dark-custom {
    background-color: #121212 !important;
  }
</style>
<script >


import { defineComponent } from 'vue'
import { tdc } from '../boot/app'
import { AuthStore, UserStore } from '../stores/AuthStore'


export default defineComponent({
  name: 'PageLeftMenuSegundo',

  props: {
    AllPermissions: {
      type: Array,
      required: true
    }
  },

  components: {

  },
  setup () {
    const Auth = AuthStore()
    const  User = UserStore()
    return {
      // TipoEntidade,
      // UserPermicoes,
      // Entidade
      Auth,
      User
    }
  },
  data () {
    return {
      AllMenus: [],
      Menus: [],
      Modelos: [],
      ModelosEntidade: [],
      optionsGroupPermissions: [],
      optionsAllPermissions: [],
      group: null,
      tdc: tdc,
      add_modal: false,
      searchAllPermission: null,
      searchPermission: null,
    }
  },
  computed: {

  },
  watch: {
    AllPermissions (newVal, oldVal) {
      this.filterOptionsAllPermissions('')
    },

    TipoEntidade (newVal, oldVal) {
      this.setModelos()
      this.setMenus()
    }
  },
  mounted () {
    this.filterOptionsAllPermissions('')
  },
  methods: {
    async setModelos () {
      await HTTPAuth.get(url({ type: 'u', url: 'auth/entidades/' + this.User?.Entidade?.id + '/modelos', params: {} }))
        .then(res => {
          res.data.forEach(m => {
            this.ModelosEntidade.push(m.model)
            if (!this.Modelos.includes(m.app_label)) {
              this.Modelos.push(m.app_label)
            }
          })
        }).catch(err => {
          console.log(err)
        })
    },
    async setMenus () {
      await HTTPAuth.get(url({ type: 'u', url: 'auth/tipoEntidades/' + this.Auth?.TipoEntidade.id + '/menus', params: {} }))
        .then(res => {
          this.AllMenus = res.data
          this.Menus = this.AllMenus
        }).catch(err => {
          console.log(err)
        })
    },
    filterOptionsAllPermissions (val) {
      if (val === '') {
        this.Menus = this.AllMenus
      } else {
        const needle = val.toLowerCase()
        this.Menus = this.AllMenus.map(v => ({
          ...v,
          submenu: v.submenu.filter(sub =>
            sub.menu && sub.menu.toLowerCase().includes(needle.toLowerCase())
          )
        })).filter(v => v.submenu.length > 0)
      }
    }
  }
})
</script>
