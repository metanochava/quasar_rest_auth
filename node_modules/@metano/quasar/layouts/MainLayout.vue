<template>
  <q-layout view="hHh lpR fFf">

    <!-- -------------------- DIALOGS -------------------- -->
    <q-dialog v-model="permissoes" persistent>
      <UserPermissoes />
    </q-dialog>

    <q-dialog v-model="pagepermissoes" persistent>
      <PagePermissoes />
    </q-dialog>

    <q-dialog v-model="definicoes_modal" full-width full-height>
      <q-card>
        <q-bar :class="$q.dark.isActive ? 'bg-primary' : 'bg-primary text-white'">
          <q-toolbar-title>
            <span class="text-weight-bold">Definições de Layout</span>
          </q-toolbar-title>
          <q-space />
          <q-btn dense flat icon="close" v-close-popup />
        </q-bar>

        <q-separator />

        <q-card-section class="scroll">
          <DefinicoesLayout />
        </q-card-section>
      </q-card>
    </q-dialog>

    <q-dialog v-model="api_retorno_modal" full-width full-height>
      <q-card>
        <q-bar class="bg-primary text-white">
          <q-toolbar-title>
            <span class="text-weight-bold">API</span>
          </q-toolbar-title>
          <q-space />
          <q-btn dense flat icon="close" v-close-popup />
        </q-bar>

        <q-separator />

        <q-card-section class="scroll">
          <ApiRetorno />
        </q-card-section>
      </q-card>
    </q-dialog>

    <!-- -------------------- HEADER -------------------- -->
    <q-header bordered :class="$q.dark.isActive ? 'bg-dark text-white' : 'bg-primary text-white'"  >
      <q-toolbar class="no-wrap q-px-md">

        <!-- Menu Esquerdo -->
        <q-btn
          dense flat round icon="menu"
          @click="ui.toggleLeft()"
          v-if="entidadeName !== 'Hakela'"
        />

        <!-- Marca (logo + nome) -->
        <HeaderBrand />

        <q-space />

        <!-- Dark Mode -->
        <HeaderDarkModeToggle />

        <!-- Full Screen -->
        <HeaderFullScreen />

        <!-- Idiomas -->
        <HeaderLanguageSelector />

        <!-- Serviços -->
        <Servicos v-if="entidadeName !== 'Hakela'" />

        <!-- Notificações -->
        <Notificacoes v-if="$route.name !== 'home'" />

        <!-- User Menu -->
        <HeaderUser />

        <!-- Menu Direito -->
        <q-btn
          dense flat round icon="menu"
          @click="ui.toggleRight()"
          v-show="$route.name !== 'oo' && entidadeName !== 'Hakela'"
        />

      </q-toolbar>
      <q-bar >
        <div class="q-pa-sm q-pl-md  items-center text-body1">
          <div class="q-ml-md cursor-pointer non-selectable">
            <q-item clickable dense replace v-ripple
              :class="$q.dark.isActive ? 'bg-dark text-white' : 'bg-primary text-white'"  >
              <q-item-section avatar @click="$router.push({ name: 'home'})" >
                <q-icon  name="home" />
              </q-item-section>
              <q-item-section class="text-body1" @click="$router.push({ name: 'home'})" >{{ ('Casa') }}</q-item-section>
              <q-item-section side>
                <q-btn
                round dense flat
                :icon="'arrow_back'" :class="$q.dark.isActive ? 'text-white' : 'text-white'"
              
              ></q-btn>
              </q-item-section>

            </q-item>
          </div>
        </div>

        <TopMenuSegundo :AllPermissions="AllPermissions"></TopMenuSegundo>
      </q-bar>
    </q-header>
    

    <!-- -------------------- LEFT DRAWER -------------------- -->
    <q-drawer
      v-model="ui.leftDrawer"
      show-if-above
      :mini="miniState"
      side="left"
      bordered
      class="q-pr-0"
      :width="300"
    >
      <!-- User info in drawer -->
      <q-card :class="'absolute-bottom q-pa-md' + $q.dark.isActive ? 'bg-dark text-white' : 'bg-primary text-white'"  flat>
        <div class="text-center text-h6">{{ User?.username }}</div>
        <q-btn
          flat dense
          :label="UserPerfil?.name"
          class="full-width"
        >
          <q-menu fit>
            <q-list dense>
              <q-item v-for="grupo in UserPerfils" :key="grupo.id" clickable @click="selectGroup(grupo)">
                <q-item-section>{{ grupo.name }}</q-item-section>
              </q-item>
            </q-list>
          </q-menu>
        </q-btn>

      </q-card>

      <q-scroll-area class="fit" :thumb-style="thumbStyle" :bar-style="barStyle">
        <LeftMenu v-if="User && User.username !== 'Hóspede'" />
        <LeftMenu />
      </q-scroll-area>
    </q-drawer>

    <!-- -------------------- RIGHT DRAWER -------------------- -->
    <q-drawer
      v-model="ui.rightDrawer"
      side="right"
      bordered
      :width="300"
    >
      <q-scroll-area class="fit" :thumb-style="thumbStyle" :bar-style="barStyle">
        <RightMenu />
      </q-scroll-area>
    </q-drawer>

    <!-- -------------------- PAGE CONTAINER -------------------- -->
    <q-page-container class="bg-grey-1">

      <!-- Alerts -->
      <div class="col text-center" v-show="Alerts?.length > 0">
        <q-btn dense flat icon="close" @click="removeAlertAll()" />
      </div>

      <q-item
        v-for="alert in Alerts"
        :key="alert"
        :class="'bg-' + alert.type + ' q-pa-xs text-white q-ma-xs'"
      >
        <q-item-section>{{ alert.sms }}</q-item-section>
        <q-item-section side>
          <q-btn dense flat icon="close" @click="removeAlert(alert)" />
        </q-item-section>
      </q-item>

      <!-- Conteúdo principal -->
      <q-scroll-area class="fit" :thumb-style="thumbStyle">
        <router-view v-show="!visibilidadeLoad" />

        <q-inner-loading :showing="visibilidadeLoad">
          <q-spinner-gears size="80px" color="primary" />
        </q-inner-loading>
      </q-scroll-area>

    </q-page-container>

    <!-- -------------------- RODAPÉ -------------------- -->
    <RodapeKakela v-if="entidadeName === 'Hakela'" />
    <Rodape v-else />

    <!-- -------------------- PAGE SCROLLER -------------------- -->
    <q-page-scroller position="bottom-right" :scroll-offset="50" :offset="[18, -10]">
      <q-btn icon="keyboard_arrow_up" color="primary" round />
    </q-page-scroller>

  </q-layout>
</template>

<script setup>
/* -------------------- IMPORT STORES -------------------- */
import { storeToRefs } from "pinia";
import { useUserStore } from "src/stores/useUserStore";
import { useUIStore } from "src/stores/useUIStore";

/* -------------------- IMPORT COMPONENTS -------------------- */
import HeaderBrand from "src/components/header/HeaderBrand.vue";
import HeaderUser from "src/components/header/HeaderUser.vue";
import HeaderDarkModeToggle from "src/components/header/HeaderDarkModeToggle.vue";
import HeaderLanguageSelector from "src/components/header/HeaderLanguageSelector.vue";
import HeaderFullScreen from "src/components/header/HeaderFullScreen.vue";
import Servicos from "src/components/header/HeaderServices.vue";
import Notificacoes from "src/components/header/HeaderNotifications.vue";



import LeftMenu from "src/components/LeftMenu.vue";
import RightMenu from "src/components/RightMenu.vue";
import Rodape from "src/components/footer/MainFooter.vue";
// import RodapeKakela from "src/components/HakelaFooter.vue";

/* -------------------- STATE -------------------- */
const userStore = useUserStore();
const ui = useUIStore();

const { user: User, perfilActual: UserPerfil, perfis: UserPerfils } = storeToRefs(userStore);
// const { leftDrawer, rightDrawer, dark } = storeToRefs(ui);

/* -------------------- LOCAL STATE -------------------- */
import { ref } from "vue";
const permissoes = ref(false);
const pagepermissoes = ref(false);
const definicoes_modal = ref(false);
const api_retorno_modal = ref(false);
const visibilidadeLoad = ref(false);

const miniState = ref(false);

/* -------------------- METHODS -------------------- */
function selectGroup(group) {
  userStore.perfilActual = group;
}

/* -------------------- FOOTER LOGIC -------------------- */
const entidadeName = User.value?.entidade?.nome || "Instituição";

/* -------------------- AUX VALUES -------------------- */
// import { thumbStyle, barStyle } from "src/css/appStyle";
</script>

<style>
</style>

